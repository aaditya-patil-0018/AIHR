<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Interview</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white p-8 rounded-lg shadow-lg max-w-lg w-full">
        <h1 class="text-3xl font-semibold text-center text-gray-800 mb-6">Video Interview</h1>
        <!-- <p class="text-gray-600 text-center mb-4">Camera permission will be requested below. Please grant permission to proceed.</p> -->

        <div class="relative w-full h-80 bg-gray-200 rounded-lg overflow-hidden mb-4">
            <video id="videoElement" autoplay class="w-full h-full object-cover rounded-lg"></video>
            <!-- Optional loading spinner while waiting for camera access -->
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 text-white text-xl font-bold rounded-lg">
                Loading camera...
            </div>
        </div>

        <div class="text-center mb-4">
            <p id="emotionText" class="text-lg text-gray-700">Waiting for analysis...</p>
        </div>

    </div>

    <script>
        // Capture video frame and send it for emotion analysis
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true
                });

                const videoElement = document.getElementById('videoElement');
                const loading = document.getElementById('loading');
                loading.style.display = 'none';
                videoElement.srcObject = stream;

                // Set up a canvas to capture frames from the video
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                // Function to capture frames and send to server for emotion analysis
                setInterval(async () => {
                    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    const imageData = canvas.toDataURL('image/jpeg');
                    await analyzeEmotion(imageData);
                }, 1000); // Capture frame every second

                // Optional: Handle stream end or errors
                stream.getTracks().forEach(track => {
                    track.onended = () => {
                        alert('Camera stream ended');
                    };
                });

            } catch (err) {
                console.error('Error accessing the camera:', err);
                alert('Camera access denied or failed.');
            }
        }

        // Function to send the captured image to the server for emotion analysis
        async function analyzeEmotion(imageData) {
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    const emotionText = document.getElementById('emotionText');
                    emotionText.innerHTML = `Emotion: ${result.extended_emotion}`;
                } else {
                    console.error('Error analyzing emotion:', result.error);
                }
            } catch (error) {
                console.error('Error sending image to server:', error);
            }
        }

        // Start the camera as soon as the page loads
        window.onload = function () {
            startCamera();
        };
    </script>

</body>

</html>